// ../JS/translation.js

const translations = {
  en: {
    "nav.home": "Home",
    "nav.about": "About Us",
    "nav.trips": "Our Trips",
    "nav.signin": "Sign In",
    // meta / a11y
    "date.start": "Start Date",
    "date.end": "End Date",
    "aria.searchTrips": "Search trips",
    "aria.swapDates": "Swap start and end dates",
    "slider.prev": "Previous image",
    "slider.next": "Next image",
    "header.allTrips": "All Trips",

    // trending / slider labels
    "trending.mins": "min",
    "trending.available": "Available now",
    "trending.unavailable": "Currently unavailable",
    "trending.trending": "TRENDING NOW",
    "trending.book": "Book Now",
    "trending.reviews": "reviews",
    "trending.prev": "Previous",
    "trending.next": "Next",

    // cards / lists
    "card.available": "Available",
    "card.unavailable": "Unavailable",
    "card.reviews": "reviews",
    "card.perPerson": "/person",

    // empty / error / misc
    "empty.noTopRated": "No top rated trips yet.",
    "empty.noTripsInCategory": "No other trips found in this category.",
    "error.loadTrips": "Something went wrong loading trips. Please try again.",
    "img.noImage": "No Image",
    "gallery.imageAlt": "Image {n}",
    "featured.bestSeller": "Best Seller",
    "sidebar.showMore": "Show more",
    "sidebar.showLess": "Show less",

    // time tokens
    "time.hourShort": "h",
    "time.minShort": "min",

    "about.pageTitle": "About Us | TripZaEgypt",
    "about.hero.title": "Who We Are",
    "about.hero.subtitle":
      "At TripZaEgypt, we're passionate about connecting people with unforgettable experiences across the globe. With carefully curated trips and seamless planning, we take the stress out of travel so you can focus on the adventure.",

    "about.mission.imageAlt": "Our Mission",
    "about.mission.title": "Our Mission",
    "about.mission.desc":
      "We aim to inspire and empower travelers to explore the world, experience different cultures, and create lifelong memories — all through personalized, high-quality tour services.",
    "about.mission.point1": "Tailored travel packages",
    "about.mission.point2": "Expert local guides",
    "about.mission.point3": "Eco-friendly practices",
    "about.mission.point4": "Reliable customer support",

    "about.cta.title": "Ready to Explore With Us?",
    "about.cta.subtitle":
      "Start your journey today and experience travel like never before.",
    "about.cta.button": "Browse Tours",

    "menu.name": "Menu",
    "menu.lang": "Language",
    "search.label": "Search",
    "search.trips": "Trips",
    "search.trip.placeholder": "Search A Trip",
    "search.guests": "Guests",
    "search.guests.placeholder": "Guests",
    "search.date": "Date",

    "trips.sectionTitle": "Explore Trips By Category",
    "trips.sectionDesc":
      "Browse our top-rated experiences in Hurghada — from thrilling desert safaris to relaxing Red Sea escapes.",
    "trend.name": "Trending Now",
    "trend.button": "Book Now",
    "trend.sectionTitle": "Explore Some of Our Trending Trips",
    "trend.sectionDesc":
      "Browse our Best Seller Trips in Hurghada — from thrilling desert safaris to relaxing Red Sea escapes",
    "trend.btn": "Explore All the Trips",
    "gallery.title": "From The Gallery",
    // ← fixed key
    "gallery.subtitle":
      "Moments captured. Memories made. Discover Hurghada through our lens.",
    "footer.lang": "Language",
    "footer.company": "Company",
    "footer.about": "About Us",
    "footer.blog": "Blog",
    "footer.careers": "Careers",
    "footer.help": "Help",
    "footer.contactUs": "Contact Us",
    "footer.faqs": "FAQs", // ← fixed key
    "footer.terms": "Terms",
    "footer.follow": "Follow Us",

    "signin.name": "Sign in",
    "signin.subtitle": "Access exclusive tour experiences with your account",
    "signin.email": "Email",
    "signin.pass": "Password",
    "signin.button": "Sign In",
    "signin.create": "or create account",

    "signup.title": "Create Account",
    "signup.subtitle": "Join the adventure and explore new destinations",
    "signup.name": "Full Name",
    "signup.email": "Email",
    "signup.pass": "Password",
    "signup.confirmPass": "Confirm Password",
    "signup.button": "Create Account",
    "signup.haveAccount": "Already have an account?",
    "signup.signin": "Sign in",
  },
  deu: {
    "nav.home": "Startseite",
    "nav.about": "Über uns",
    "nav.trips": "Unsere Reisen",
    "nav.signin": "Anmelden",
    // meta / a11y
    "date.start": "Startdatum",
    "date.end": "Enddatum",
    "aria.searchTrips": "Reisen suchen",
    "aria.swapDates": "Start- und Enddatum tauschen",
    "slider.prev": "Vorheriges Bild",
    "slider.next": "Nächstes Bild",
    "header.allTrips": "Alle Reisen",

    // trending / slider labels
    "trending.mins": "Min.",
    "trending.available": "Jetzt verfügbar",
    "trending.unavailable": "Derzeit nicht verfügbar",
    "trending.trending": "JETZT IM TREND",
    "trending.book": "Jetzt buchen",
    "trending.reviews": "Bewertungen",
    "trending.prev": "Vorheriger",
    "trending.next": "Nächster",

    // cards / lists
    "card.available": "Verfügbar",
    "card.unavailable": "Nicht verfügbar",
    "card.reviews": "Bewertungen",
    "card.perPerson": "/Person",

    // empty / error / misc
    "empty.noTopRated": "Noch keine Top-bewerteten Reisen.",
    "empty.noTripsInCategory":
      "Keine weiteren Reisen in dieser Kategorie gefunden.",
    "error.loadTrips":
      "Beim Laden der Reisen ist etwas schiefgelaufen. Bitte versuche es erneut.",
    "img.noImage": "Kein Bild",
    "gallery.imageAlt": "Bild {n}",
    "featured.bestSeller": "Bestseller",
    "sidebar.showMore": "Mehr anzeigen",
    "sidebar.showLess": "Weniger anzeigen",

    // time tokens
    "time.hourShort": "Std.",
    "time.minShort": "Min.",

    "about.pageTitle": "Über uns | TripZaEgypt",
    "about.hero.title": "Wer wir sind",
    "about.hero.subtitle":
      "Bei TripZaEgypt verbinden wir Menschen mit unvergesslichen Erlebnissen weltweit. Mit sorgfältig kuratierten Reisen und reibungsloser Planung nehmen wir den Stress aus dem Reisen, damit du dich ganz auf das Abenteuer konzentrieren kannst.",

    "about.mission.imageAlt": "Unsere Mission",
    "about.mission.title": "Unsere Mission",
    "about.mission.desc":
      "Wir möchten Reisende inspirieren und befähigen, die Welt zu entdecken, verschiedene Kulturen zu erleben und lebenslange Erinnerungen zu schaffen — durch persönliche, hochwertige Tour-Services.",
    "about.mission.point1": "Maßgeschneiderte Reisepakete",
    "about.mission.point2": "Erfahrene lokale Guides",
    "about.mission.point3": "Umweltfreundliche Praktiken",
    "about.mission.point4": "Zuverlässiger Kundensupport",

    "about.cta.title": "Bereit, mit uns auf Entdeckungsreise zu gehen?",
    "about.cta.subtitle":
      "Starte noch heute deine Reise und erlebe Reisen wie nie zuvor.",
    "about.cta.button": "Touren durchsuchen",

    "menu.name": "Menü",
    "menu.lang": "Sprache",
    "search.label": "Suchen",
    "search.trips": "Reisen",
    "search.trip.placeholder": "Reise suchen",
    "search.guests": "Gäste",
    "search.guests.placeholder": "Gäste",
    "search.date": "Datum",

    "trips.sectionTitle": "Beliebte Reisen entdecken",
    "trips.sectionDesc":
      "Durchstöbern Sie unsere Top-Erlebnisse in Hurghada – von aufregenden Wüstensafaris bis zu entspannenden Ausflügen am Roten Meer.",
    "trend.name": "Jetzt im Trend",
    "trend.button": "Jetzt buchen",
    "trend.sectionTitle": "Entdecken Sie einige unserer Trend-Reisen",
    "trend.sectionDesc":
      "Durchstöbern Sie unsere Bestseller in Hurghada – von aufregenden Wüstensafaris bis zu entspannenden Ausflügen am Roten Meer",
    "trend.btn": "Alle Reisen entdecken",
    "gallery.title": "Aus der Galerie",
    "gallery.subtitle":
      "Eingefangene Momente. Geschaffene Erinnerungen. Entdecken Sie Hurghada durch unsere Linse.",
    "footer.lang": "Sprache",
    "footer.company": "Unternehmen",
    "footer.about": "Über uns",
    "footer.blog": "Blog",
    "footer.careers": "Karriere",
    "footer.help": "Hilfe",
    "footer.contactUs": "Kontakt",
    "footer.faqs": "FAQs", // ← fixed key
    "footer.terms": "Bedingungen",
    "footer.follow": "Folgen Sie uns",

    "signin.name": "Anmelden",
    "signin.subtitle":
      "Greifen Sie mit Ihrem Konto auf exklusive Tourerlebnisse zu",
    "signin.email": "E-Mail",
    "signin.pass": "Passwort",
    "signin.button": "Anmelden",
    "signin.create": "oder Konto erstellen",

    "signup.title": "Konto erstellen",
    "signup.subtitle":
      "Schließen Sie sich dem Abenteuer an und entdecken Sie neue Reiseziele",
    "signup.name": "Vollständiger Name",
    "signup.email": "E-Mail",
    "signup.pass": "Passwort",
    "signup.confirmPass": "Passwort bestätigen",
    "signup.button": "Konto erstellen",
    "signup.haveAccount": "Haben Sie bereits ein Konto?",
    "signup.signin": "Anmelden",
  },
};

const FALLBACK_LANG = "en";
window.t = function t(key, params = {}) {
  const lang =
    window.__currentLang || localStorage.getItem("lang") || FALLBACK_LANG;
  let str =
    translations?.[lang]?.[key] ?? translations?.[FALLBACK_LANG]?.[key] ?? "";

  for (const [k, v] of Object.entries(params)) {
    str = str.replace(new RegExp(`\\{${k}\\}`, "g"), String(v));
  }
  return str;
};

window.__currentLang = window.__currentLang || null;

function setLanguage(lang) {
  const prev = window.__currentLang || null;
  const languageChanged = prev !== lang;
  window.__currentLang = lang;

  // --- helper: safe translate (uses window.t if present; else falls back) ---
  const translate = (key, params = {}) => {
    if (typeof window.t === "function") return window.t(key, params);
    const fallback = "en";
    const dict = translations?.[lang] || translations?.[fallback] || {};
    let str = dict[key] || translations?.[fallback]?.[key] || "";
    for (const [k, v] of Object.entries(params)) {
      str = str.replace(new RegExp(`\\{${k}\\}`, "g"), String(v));
    }
    return str;
  };

  // --- delegate languageSelect change globally (works for injected headers/footers) ---
  if (!window.__langDelegationBound) {
    window.__langDelegationBound = true;
    document.addEventListener(
      "change",
      (e) => {
        const sel = e.target?.closest?.("#languageSelect");
        if (sel && sel.value) setLanguage(sel.value);
      },
      true // capture to catch events even inside shadowed/injected DOM
    );
  }

  // --- 1) Translate elements with data-i18n (textContent) ---
  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    const val = translate(key);
    if (val) el.textContent = val;
  });

  // --- 2) Translate any data-i18n-ATTR => set ATTR (placeholder, title, aria-label, etc.) ---
  document.querySelectorAll("*").forEach((el) => {
    const attrs = el.getAttributeNames?.() || [];
    for (const attr of attrs) {
      const m = /^data-i18n-(.+)$/.exec(attr);
      if (!m) continue;
      const targetAttr = m[1]; // e.g., "placeholder", "aria-label", "title"
      const key = el.getAttribute(attr);
      const val = translate(key);
      if (!val) continue;

      if (targetAttr === "text") {
        // optional: <span data-i18n-text="some.key"></span>
        el.textContent = val;
      } else {
        el.setAttribute(targetAttr, val);
      }
    }
  });

  // --- 3) Keep <title> in sync ---
  const titleStr = translate("web.title");
  if (titleStr) document.title = titleStr;

  // --- 4) Update little UI language badges/controls ---
  const codeLabel = lang === "deu" ? "DE" : lang.toUpperCase();
  const mobileLangLabel = document.getElementById("mobileLangLabel");
  if (mobileLangLabel) mobileLangLabel.innerText = codeLabel;

  const currentLang = document.getElementById("currentLang");
  if (currentLang) currentLang.innerText = codeLabel;

  const select = document.getElementById("languageSelect");
  if (select && select.value !== lang) select.value = lang;

  // --- 5) Sync <html lang="..."> for accessibility / spellcheck ---
  document.documentElement.setAttribute("lang", lang === "deu" ? "de" : "en");

  // --- 6) If Flatpickr is mounted, update visible placeholders on its altInputs ---
  try {
    const sFP = document.querySelector("#homeStartDate")?._flatpickr;
    const eFP = document.querySelector("#homeEndDate")?._flatpickr;
    sFP?.altInput?.setAttribute("placeholder", translate("date.start"));
    eFP?.altInput?.setAttribute("placeholder", translate("date.end"));
  } catch {}

  // --- 7) Persist + refresh language-dependent data only if actual change ---
  if (languageChanged) {
    try {
      localStorage.setItem("lang", lang);
    } catch {}
    // refresh dynamic areas (trending, categories, trip details, etc.)
    window.refreshLangData?.();
    window.refreshTripDetailsLang?.();
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const savedLang = localStorage.getItem("lang") || "en";
  if (window.__currentLang !== savedLang) {
    setLanguage(savedLang);
  } else {
    const select = document.getElementById("languageSelect");
    if (select && select.value !== savedLang) select.value = savedLang;
  }

  const select = document.getElementById("languageSelect");
  if (select) {
    select.addEventListener("change", () => {
      setLanguage(select.value);
    });
  }
});
