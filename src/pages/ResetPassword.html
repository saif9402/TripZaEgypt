<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="reset.pageTitle">Reset Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <!-- Toast container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <div class="bg-white w-full max-w-md rounded-2xl shadow-xl p-6">
      <h1
        class="text-2xl font-bold text-gray-800 text-center"
        data-i18n="reset.title"
      >
        Reset your password
      </h1>
      <p
        class="text-gray-500 text-sm text-center mt-1"
        data-i18n="reset.subtitle"
      >
        Choose a strong password you don’t use elsewhere.
      </p>

      <form id="resetForm" class="mt-6 space-y-4">
        <!-- New password -->
        <div>
          <label
            for="newPassword"
            class="block text-sm text-gray-700"
            data-i18n="reset.new"
          >
            New password
          </label>
          <div class="relative mt-1">
            <input
              type="password"
              id="newPassword"
              name="newPassword"
              minlength="8"
              required
              autocomplete="new-password"
              class="w-full px-4 py-2 pr-11 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"
              placeholder="••••••••"
              data-i18n-placeholder="reset.placeholder"
            />
            <button
              type="button"
              id="toggleNew"
              class="absolute inset-y-0 right-3 flex items-center text-gray-500 hover:text-gray-700"
              aria-label="Show password"
              title="Show password"
            >
              <!-- eye -->
              <svg
                id="eyeNew"
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.8"
                  d="M2.25 12s3.75-6.75 9.75-6.75S21.75 12 21.75 12s-3.75 6.75-9.75 6.75S2.25 12 2.25 12z"
                />
                <circle cx="12" cy="12" r="3.25" stroke-width="1.8" />
              </svg>
              <!-- eye-off -->
              <svg
                id="eyeOffNew"
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.8"
                  d="M3 3l18 18M10.58 10.58A3.25 3.25 0 0112 8.75c1.8 0 3.25 1.45 3.25 3.25 0 .5-.11.97-.31 1.39m-1.55 1.55A3.24 3.24 0 0112 15.25M4.5 7.5C6.7 5.7 9.22 5.25 12 5.25c6 0 9.75 6.75 9.75 6.75a17.1 17.1 0 01-3.02 3.86M7.38 16.62A13.8 13.8 0 012 12s.77-1.45 2.5-3"
                />
              </svg>
            </button>
          </div>

          <!-- Strength meter -->
          <div class="mt-2">
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
              <div
                id="strengthBar"
                class="h-2 w-0 bg-yellow-400 transition-all"
              ></div>
            </div>
            <div
              id="strengthText"
              class="text-xs text-gray-500 mt-1"
              data-i18n="reset.strength.hint"
            >
              At least 8 characters.
            </div>
          </div>
        </div>

        <!-- Confirm password -->
        <div>
          <label
            for="confirmPassword"
            class="block text-sm text-gray-700"
            data-i18n="reset.confirm"
          >
            Confirm password
          </label>
          <div class="relative mt-1">
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              required
              autocomplete="new-password"
              class="w-full px-4 py-2 pr-11 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"
              placeholder="••••••••"
              data-i18n-placeholder="reset.placeholder"
            />
            <button
              type="button"
              id="toggleConfirm"
              class="absolute inset-y-0 right-3 flex items-center text-gray-500 hover:text-gray-700"
              aria-label="Show password"
              title="Show password"
            >
              <!-- eye -->
              <svg
                id="eyeConfirm"
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.8"
                  d="M2.25 12s3.75-6.75 9.75-6.75S21.75 12 21.75 12s-3.75 6.75-9.75 6.75S2.25 12 2.25 12z"
                />
                <circle cx="12" cy="12" r="3.25" stroke-width="1.8" />
              </svg>
              <!-- eye-off -->
              <svg
                id="eyeOffConfirm"
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.8"
                  d="M3 3l18 18M10.58 10.58A3.25 3.25 0 0112 8.75c1.8 0 3.25 1.45 3.25 3.25 0 .5-.11.97-.31 1.39m-1.55 1.55A3.24 3.24 0 0112 15.25M4.5 7.5C6.7 5.7 9.22 5.25 12 5.25c6 0 9.75 6.75 9.75 6.75a17.1 17.1 0 01-3.02 3.86M7.38 16.62A13.8 13.8 0 012 12s.77-1.45 2.5-3"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Inline message area -->
        <div id="message" class="text-sm hidden"></div>

        <button
          type="submit"
          id="submitBtn"
          class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-2 rounded-lg shadow-md transition"
          data-i18n="reset.cta"
        >
          Reset Password
        </button>

        <p class="text-center text-sm text-gray-500">
          <a
            href="sign-in.html"
            class="text-yellow-600 hover:underline"
            data-i18n="reset.backToSignIn"
            >Back to sign in</a
          >
        </p>
      </form>
    </div>

    <!-- Your translator (must come before our inline script) -->
    <script src="../JS/translation.js"></script>

    <script>
      // Minimal toast (uses your global showToast if present)
      function toast(msg, type = "success") {
        if (window.showToast) return showToast(msg, type);
        const box = document.createElement("div");
        box.className = `max-w-sm w-full px-4 py-3 rounded-lg shadow-lg text-white ${
          type === "success" ? "bg-green-600" : "bg-red-600"
        }`;
        box.textContent = msg;
        const wrap = document.getElementById("toast-container");
        wrap.appendChild(box);
        setTimeout(() => {
          box.style.opacity = "0";
          box.addEventListener("transitionend", () => box.remove());
        }, 3000);
      }

      // ---- i18n helpers (use global translator if present) ----
      const getLang = () =>
        window.__currentLang || localStorage.getItem("lang") || "en";
      const tr = (k) =>
        typeof window.t === "function"
          ? window.t(k)
          : window.translations?.[getLang()]?.[k] || k;

      // Read params (support userid or userId, token normalization)
      const params = new URLSearchParams(window.location.search);
      const userId = params.get("userId") || params.get("userid") || "";
      let token = params.get("token") || "";
      if (token) token = decodeURIComponent(token).replace(/ /g, "+");

      const form = document.getElementById("resetForm");
      const msg = document.getElementById("message");
      const submitBtn = document.getElementById("submitBtn");
      const newPwd = document.getElementById("newPassword");
      const confirmPwd = document.getElementById("confirmPassword");
      const strengthBar = document.getElementById("strengthBar");
      const strengthText = document.getElementById("strengthText");

      // Guard: missing token or user id
      if (!userId || !token) {
        msg.className = "text-sm text-red-600";
        msg.textContent = tr("reset.message.missingLink");
        submitBtn.disabled = true;
      }

      // Eye toggles with localized titles/aria-labels
      function setToggleLabels(btn, show) {
        const lbl = show ? tr("reset.aria.hidePwd") : tr("reset.aria.showPwd");
        btn.setAttribute("aria-label", lbl);
        btn.setAttribute("title", lbl);
        btn.setAttribute("aria-pressed", show ? "true" : "false");
      }
      function wireToggle(btnId, input, eyeId, eyeOffId) {
        const btn = document.getElementById(btnId);
        const eye = document.getElementById(eyeId);
        const eyeOff = document.getElementById(eyeOffId);
        if (!btn) return;
        // init labels
        setToggleLabels(btn, false);
        btn.addEventListener("click", () => {
          const show = input.type === "password";
          input.type = show ? "text" : "password";
          setToggleLabels(btn, show);
          eye.classList.toggle("hidden", !show);
          eyeOff.classList.toggle("hidden", show);
        });
      }
      wireToggle("toggleNew", newPwd, "eyeNew", "eyeOffNew");
      wireToggle("toggleConfirm", confirmPwd, "eyeConfirm", "eyeOffConfirm");

      // Strength meter (simple heuristic)
      function calcStrength(p) {
        let s = 0;
        if (p.length >= 8) s += 1;
        if (/[A-Z]/.test(p)) s += 1;
        if (/[a-z]/.test(p)) s += 1;
        if (/\d/.test(p)) s += 1;
        if (/[^A-Za-z0-9]/.test(p)) s += 1;
        return s; // 0..5
      }
      function strengthLabel(score) {
        // 1..5 -> labels (empty => hint)
        if (score <= 0) return tr("reset.strength.hint");
        if (score === 1) return tr("reset.strength.tooWeak");
        if (score === 2) return tr("reset.strength.weak");
        if (score === 3) return tr("reset.strength.okay");
        if (score === 4) return tr("reset.strength.good");
        return tr("reset.strength.strong");
      }
      function renderStrength(p) {
        const s = calcStrength(p);
        strengthBar.style.width = (s / 5) * 100 + "%";
        strengthText.textContent = p.length
          ? strengthLabel(s)
          : tr("reset.strength.hint");
      }
      newPwd.addEventListener("input", () => renderStrength(newPwd.value));
      renderStrength("");

      // Re-translate dynamic bits if language changes
      document.addEventListener("i18n:change", () => {
        renderStrength(newPwd.value);
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.classList.add("hidden");

        const newPassword = newPwd.value.trim();
        const confirm = confirmPwd.value.trim();

        if (newPassword.length < 8) {
          msg.className = "text-sm text-red-600";
          msg.textContent = tr("reset.error.minLength");
          msg.classList.remove("hidden");
          return;
        }
        if (newPassword !== confirm) {
          msg.className = "text-sm text-red-600";
          msg.textContent = tr("reset.error.mismatch");
          msg.classList.remove("hidden");
          return;
        }

        submitBtn.disabled = true;
        const original = submitBtn.textContent;
        submitBtn.textContent = tr("reset.submitting");

        const dto = { userId, token, newPassword };

        try {
          const res = await fetch("/api/Auth/ResetPassword", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dto),
          });

          let result = {};
          try {
            result = await res.json();
          } catch {}

          if (res.ok && (result.succeeded ?? true)) {
            toast(tr("reset.success.toast"), "success");
            msg.className = "text-sm text-green-600 mt-2";
            msg.textContent = tr("reset.success.inline");
            setTimeout(() => {
              window.location.href = "sign-in.html";
            }, 1500);
          } else {
            msg.className = "text-sm text-red-600";
            msg.textContent =
              result?.errors?.join(", ") || tr("reset.error.generic");
            msg.classList.remove("hidden");
            submitBtn.disabled = false;
            submitBtn.textContent = original;
          }
        } catch {
          msg.className = "text-sm text-red-600";
          msg.textContent = tr("reset.error.network");
          msg.classList.remove("hidden");
          submitBtn.disabled = false;
          submitBtn.textContent = original;
        }
      });
    </script>
  </body>
</html>
