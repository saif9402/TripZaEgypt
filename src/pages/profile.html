<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Profile | Tour Guide</title>

    <!-- Tailwind build + site styles -->
    <link href="../output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/styles.css" />

    <!-- Icons / Alpine (optional) -->
    <link
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>

    <!-- Block unauthenticated users (uses the same token your email/password flow stores) -->
    <script>
      if (!localStorage.getItem("accessToken")) {
        // If your Google flow sets an HttpOnly cookie (no token), remove this redirect,
        // or replace with a lightweight "ping" to your API to verify session.
        window.location.href = "/pages/login.html";
      }
    </script>
  </head>

  <body class="bg-gray-50 font-sans text-gray-800">
    <!-- Toasts (also used by the blocking modal) -->
    <div
      id="toast-container"
      class="fixed top-4 right-4 z-[10000] space-y-2"
    ></div>

    <!-- Navbar -->
    <div id="header-placeholder"></div>

    <!-- Main -->
    <main class="max-w-6xl mx-auto mt-16 px-6">
      <div
        class="bg-white shadow-lg rounded-2xl p-8 flex flex-col lg:flex-row gap-8"
      >
        <!-- Sidebar -->
        <aside class="lg:w-1/4 w-full sm:border-b md:border-r border-gray-200">
          <div class="text-center">
            <div
              class="w-24 h-24 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center text-3xl text-gray-500"
            >
              <i class="fas fa-user"></i>
            </div>
            <h2 id="sidebarName" class="text-2xl font-semibold">User</h2>
            <p
              id="sidebarLocation"
              class="text-sm text-gray-500 mt-1 flex items-center justify-center"
            >
              <i class="fas fa-map-marker-alt mr-1"></i> Location
            </p>
          </div>

          <div class="mt-8 flex flex-col items-center justify-center gap-3">
            <button
              class="w-auto bg-yellow-400 hover:bg-yellow-500 transition text-black font-medium px-4 py-2 rounded-lg"
            >
              Profile Information
            </button>
            <button
              class="w-auto border border-gray-300 hover:bg-gray-100 transition text-gray-700 font-medium px-6 py-2 rounded-lg"
            >
              Booking History
            </button>
          </div>
        </aside>

        <!-- Details -->
        <section class="lg:w-3/4 w-full">
          <h2 class="text-xl font-semibold mb-6 border-b pb-2">
            Personal Information
          </h2>

          <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium mb-1" for="profileName"
                >Name</label
              >
              <input
                disabled
                id="profileName"
                type="text"
                autocomplete="name"
                class="w-full border border-gray-300 px-4 py-2 rounded-lg bg-gray-100"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="profilePhone"
                >Phone</label
              >
              <input
                disabled
                id="profilePhone"
                type="tel"
                inputmode="tel"
                autocomplete="tel"
                class="w-full border border-gray-300 px-4 py-2 rounded-lg bg-gray-100"
              />
            </div>
            <div>
              <label
                class="block text-sm font-medium mb-1"
                for="profileLocation"
                >Country</label
              >
              <input
                disabled
                id="profileLocation"
                type="text"
                autocomplete="country-name"
                class="w-full border border-gray-300 px-4 py-2 rounded-lg bg-gray-100"
              />
            </div>
          </form>

          <!-- Actions -->
          <div class="mt-6 flex items-center gap-3">
            <button
              id="editSaveBtn"
              class="bg-yellow-400 hover:bg-yellow-500 text-white font-medium px-5 py-2.5 rounded-lg transition"
            >
              <i class="fas fa-pen mr-2"></i><span>Edit</span>
            </button>
            <button
              id="cancelBtn"
              class="hidden border border-gray-300 hover:bg-gray-100 text-gray-700 font-medium px-4 py-2 rounded-lg transition"
              type="button"
            >
              Cancel
            </button>
            <span id="saveHint" class="hidden text-sm text-gray-500"
              >Edit your details, then click <b>Save changes</b>.</span
            >
          </div>

          <h2 class="text-xl font-semibold mt-10 mb-6 border-b pb-2">
            Security
          </h2>
          <form class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium mb-1" for="profileEmail"
                >Email Address</label
              >
              <input
                disabled
                id="profileEmail"
                type="email"
                class="w-full border border-gray-300 px-4 py-2 rounded-lg bg-gray-100"
              />
            </div>
          </form>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <div id="footer-placeholder" class="mt-10"></div>

    <!-- Tiny (center) toast for in-page edits if you still want it -->
    <div
      id="toast"
      class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden px-4 py-2 rounded-lg text-white shadow-lg"
    ></div>

    <!-- Shared scripts your project already uses -->
    <script src="../JS/translation.js"></script>
    <script src="../JS/transition.js"></script>
    <script src="../JS/includes.js"></script>

    <!-- Profile page logic (populate + inline edit/save to /api/Auth/Update) -->
    <script>
      // --- Helpers
      function showToast(msg, type = "success") {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.className =
          "fixed bottom-6 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-white shadow-lg " +
          (type === "success" ? "bg-green-600" : "bg-red-600");
        t.classList.remove("hidden");
        setTimeout(() => t.classList.add("hidden"), 2500);
      }

      function setInputsDisabled(disabled) {
        const ids = ["profileName", "profilePhone", "profileLocation"];
        ids.forEach((id) => {
          const el = document.getElementById(id);
          el.disabled = disabled;
          el.classList.toggle("bg-gray-100", disabled);
        });
      }

      // Populate from global currentUser if includes.js provides it
      function populateProfileWhenReady() {
        if (window.currentUser) {
          const user = window.currentUser;
          document.getElementById("profileName").value = user.fullName || "";
          document.getElementById("profilePhone").value =
            user.phoneNumber || "";
          document.getElementById("profileLocation").value = user.country || "";
          document.getElementById("profileEmail").value = user.email || "";

          document.getElementById("sidebarName").textContent =
            user.fullName || "User";
          document.getElementById("sidebarLocation").innerHTML =
            '<i class="fas fa-map-marker-alt mr-1"></i> ' +
            (user.country || "Location");
        } else {
          setTimeout(populateProfileWhenReady, 100);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        populateProfileWhenReady();

        const editSaveBtn = document.getElementById("editSaveBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const saveHint = document.getElementById("saveHint");

        // Keep a copy to restore on Cancel
        let original = { name: "", phone: "", country: "" };
        let editing = false;

        function snapshotValues() {
          original = {
            name: document.getElementById("profileName").value,
            phone: document.getElementById("profilePhone").value,
            country: document.getElementById("profileLocation").value,
          };
        }

        function restoreValues() {
          document.getElementById("profileName").value = original.name;
          document.getElementById("profilePhone").value = original.phone;
          document.getElementById("profileLocation").value = original.country;
        }

        function setEditingState(on) {
          editing = on;
          setInputsDisabled(!on);
          cancelBtn.classList.toggle("hidden", !on);
          saveHint.classList.toggle("hidden", !on);

          const icon = editSaveBtn.querySelector("i");
          const label = editSaveBtn.querySelector("span");
          if (on) {
            icon.className = "fas fa-save mr-2";
            label.textContent = "Save changes";
            // switch yellow -> green while editing to save
            editSaveBtn.classList.remove(
              "bg-yellow-400",
              "hover:bg-yellow-500"
            );
            editSaveBtn.classList.add("bg-green-600", "hover:bg-green-700");
          } else {
            icon.className = "fas fa-pen mr-2";
            label.textContent = "Edit";
            // switch back to yellow after save/cancel
            editSaveBtn.classList.add("bg-yellow-400", "hover:bg-yellow-500");
            editSaveBtn.classList.remove("bg-green-600", "hover:bg-green-700");
          }
        }

        async function callUpdateEndpoint(fullName, phoneNumber, country) {
          const token = localStorage.getItem("accessToken");
          const params = new URLSearchParams({
            FullName: fullName,
            PhoneNumber: phoneNumber,
            Country: country,
          });

          // Your backend expects POST (per your earlier code)
          return fetch("/api/Auth/Update?" + params.toString(), {
            method: "POST",
            headers: token ? { Authorization: `Bearer ${token}` } : {},
            credentials: "include",
          });
        }

        function validateInputs({ name, phone, country }) {
          if (!name.trim() || !country.trim() || !phone.trim()) {
            return "Name, Phone, and Country are required.";
          }
          if (!/^[\d+\-\s()]{6,}$/.test(phone.trim())) {
            return "Please enter a valid phone number.";
          }
          return null;
        }

        async function handleSave() {
          const name = document.getElementById("profileName").value.trim();
          const phone = document.getElementById("profilePhone").value.trim();
          const country = document
            .getElementById("profileLocation")
            .value.trim();

          const err = validateInputs({ name, phone, country });
          if (err) {
            showToast(err, "error");
            return;
          }

          // UI lock + show spinner without nuking innerHTML
          editSaveBtn.disabled = true;
          const icon = editSaveBtn.querySelector("i");
          const label = editSaveBtn.querySelector("span");
          icon.className = "fas fa-circle-notch fa-spin mr-2";
          label.textContent = "Saving…";

          try {
            const res = await callUpdateEndpoint(name, phone, country);
            if (!res.ok) {
              let errorMsg = res.statusText;
              try {
                const payload = await res.json();
                if (payload?.errors) {
                  errorMsg = Array.isArray(payload.errors)
                    ? payload.errors.join(", ")
                    : String(payload.errors);
                } else if (payload?.message) {
                  errorMsg = payload.message;
                }
              } catch (_) {}
              throw new Error(errorMsg || "Update failed");
            }

            // Update sidebar + memory
            document.getElementById("sidebarName").textContent = name;
            document.getElementById("sidebarLocation").innerHTML =
              '<i class="fas fa-map-marker-alt mr-1"></i> ' + country;

            if (window.currentUser) {
              window.currentUser.fullName = name;
              window.currentUser.phoneNumber = phone;
              window.currentUser.country = country;
            }

            snapshotValues(); // new baseline
            setEditingState(false); // switches to yellow + "Edit"
            showToast("Profile updated successfully.");
          } catch (ex) {
            console.error(ex);
            showToast(ex.message || "Could not update profile.", "error");
          } finally {
            editSaveBtn.disabled = false;
            // Ensure label/icon match the current state (editing may be false now)
            if (editing) {
              icon.className = "fas fa-save mr-2";
              label.textContent = "Save changes";
            } else {
              icon.className = "fas fa-pen mr-2";
              label.textContent = "Edit";
            }
          }
        }

        // Button actions
        editSaveBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          if (!editing) {
            snapshotValues();
            setEditingState(true);
            document.getElementById("profileName").focus();
          } else {
            await handleSave();
          }
        });

        cancelBtn.addEventListener("click", (e) => {
          e.preventDefault();
          restoreValues();
          setEditingState(false);
        });
      });
    </script>

    <!-- BLOCKING MODAL: forces Phone + Country after Google sign-in (uses only /api/Auth/Update) -->
    <script>
      (function () {
        // Only trigger this gate if your Google button previously set the flag:
        // onclick="localStorage.setItem('mustCompleteProfile','1')"
        if (localStorage.getItem("mustCompleteProfile") !== "1") return;

        // ---- Toast helper (uses top-right container) ----
        function toast(message, ok = true) {
          const tc = document.getElementById("toast-container");
          const el = document.createElement("div");
          el.className =
            "max-w-sm w-full px-4 py-3 rounded-lg shadow-lg text-white animate-fade-in-up transition " +
            (ok ? "bg-green-600" : "bg-red-600");
          el.textContent = message;
          tc.appendChild(el);
          setTimeout(() => {
            el.style.opacity = "0";
            el.addEventListener("transitionend", () => el.remove());
          }, 3500);
        }

        function lockScroll(lock) {
          document.documentElement.style.overflow = lock ? "hidden" : "";
        }

        const countries = [
          "Afghanistan",
          "Albania",
          "Algeria",
          "Argentina",
          "Australia",
          "Austria",
          "Bahrain",
          "Bangladesh",
          "Belgium",
          "Brazil",
          "Canada",
          "Chile",
          "China",
          "Colombia",
          "Denmark",
          "Egypt",
          "Finland",
          "France",
          "Germany",
          "Greece",
          "India",
          "Indonesia",
          "Iran",
          "Iraq",
          "Ireland",
          "Israel",
          "Italy",
          "Japan",
          "Jordan",
          "Kenya",
          "Kuwait",
          "Lebanon",
          "Libya",
          "Malaysia",
          "Mexico",
          "Morocco",
          "Netherlands",
          "New Zealand",
          "Nigeria",
          "Norway",
          "Oman",
          "Pakistan",
          "Peru",
          "Philippines",
          "Poland",
          "Portugal",
          "Qatar",
          "Romania",
          "Russia",
          "Saudi Arabia",
          "Singapore",
          "South Africa",
          "South Korea",
          "Spain",
          "Sri Lanka",
          "Sudan",
          "Sweden",
          "Switzerland",
          "Syria",
          "Thailand",
          "Tunisia",
          "Turkey",
          "UAE",
          "UK",
          "USA",
          "Ukraine",
          "Uzbekistan",
          "Venezuela",
          "Vietnam",
          "Yemen",
          "Zimbabwe",
        ];

        // Build modal
        const overlay = document.createElement("div");
        overlay.id = "completeProfileModal";
        overlay.className =
          "fixed inset-0 z-[9999] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4";

        const u = window.currentUser || {};
        const safeName = (u.fullName || "").replace(/"/g, "&quot;");

        overlay.innerHTML = `
          <div class="bg-white w-full max-w-md rounded-2xl shadow-xl p-6 relative">
            <h2 class="text-xl font-semibold mb-1">Complete your profile</h2>
            <p class="text-sm text-gray-600 mb-4">Please add your phone number and country to continue.</p>

            <form id="cpForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input required id="cpName" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2" value="${safeName}">
                
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number <span class="text-red-500">*</span></label>
                <input id="cpPhone" type="tel" inputmode="tel" placeholder="+201234567890"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2" required />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Country <span class="text-red-500">*</span></label>
                <select id="cpCountry" class="w-full border border-gray-300 rounded-lg px-3 py-2" required></select>
              </div>

              <button id="cpSave" type="submit"
                      class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-2 rounded-lg">
                Save & Continue
              </button>
              <p class="text-[11px] text-gray-500 text-center">You can’t navigate away until this is saved.</p>
            </form>
          </div>
        `;

        document.body.appendChild(overlay);
        lockScroll(true);

        // Fill countries
        const sel = overlay.querySelector("#cpCountry");
        countries.forEach((c) => {
          const o = document.createElement("option");
          o.value = c;
          o.textContent = c;
          sel.appendChild(o);
        });
        sel.value = u.country || "Egypt";

        // Prevent closing / outside clicks / ESC
        overlay.addEventListener(
          "click",
          (e) => {
            const card = overlay.firstElementChild;
            if (!card.contains(e.target)) {
              e.stopPropagation();
              e.preventDefault();
            }
          },
          true
        );
        document.addEventListener(
          "keydown",
          (e) => {
            if (e.key === "Escape") e.preventDefault();
          },
          true
        );

        // Submit => /api/Auth/Update
        overlay
          .querySelector("#cpForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = overlay.querySelector("#cpName").value.trim();
            const phone = overlay.querySelector("#cpPhone").value.trim();
            const country = overlay.querySelector("#cpCountry").value.trim();

            if (!/^[\d+\-\s()]{6,}$/.test(phone)) {
              toast("Please enter a valid phone number.", false);
              return;
            }
            if (!country) {
              toast("Please choose your country.", false);
              return;
            }

            const btn = overlay.querySelector("#cpSave");
            const prev = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Saving…";

            const token = localStorage.getItem("accessToken");
            const params = new URLSearchParams({
              FullName: name || u.fullName || "",
              PhoneNumber: phone,
              Country: country,
            });

            try {
              const res = await fetch(`/api/Auth/Update?${params.toString()}`, {
                method: "POST", // matches your existing usage
                headers: token ? { Authorization: `Bearer ${token}` } : {},
                credentials: "include",
              });

              if (!res.ok) {
                let msg = res.statusText;
                try {
                  const payload = await res.json();
                  msg =
                    payload?.message ||
                    (Array.isArray(payload?.errors)
                      ? payload.errors.join(", ")
                      : msg);
                } catch (_) {}
                throw new Error(msg || "Update failed");
              }

              // Success: clear flag, update UI, release the user
              localStorage.setItem("mustCompleteProfile", "0");
              toast("Profile updated. You're good to go!");

              try {
                document.getElementById("profilePhone").value = phone;
                document.getElementById("profileLocation").value = country;
                if (name) document.getElementById("profileName").value = name;

                // sidebar
                document.getElementById("sidebarName").textContent =
                  name || u.fullName || "User";
                document.getElementById("sidebarLocation").innerHTML =
                  '<i class="fas fa-map-marker-alt mr-1"></i> ' + country;

                // memory
                if (window.currentUser) {
                  window.currentUser.fullName =
                    name || window.currentUser.fullName;
                  window.currentUser.phoneNumber = phone;
                  window.currentUser.country = country;
                }
              } catch (_) {}

              // remove modal and unlock scrolling
              overlay.remove();
              lockScroll(false);

              // If a page set where the user wanted to go, send them there
              const back = sessionStorage.getItem("afterProfile");
              if (back && back !== location.href) {
                sessionStorage.removeItem("afterProfile");
                location.href = back;
              }
            } catch (ex) {
              console.error(ex);
              toast(ex.message || "Could not update profile.", false);
            } finally {
              btn.disabled = false;
              btn.textContent = prev;
            }
          });
      })();
    </script>
  </body>
</html>
