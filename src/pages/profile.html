<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Profile | Tour Guide</title>

    <!-- Tailwind build + site styles -->
    <link href="../output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/styles.css" />

    <!-- Icons / Alpine (optional) -->
    <link
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>

    <!-- Block unauthenticated users -->
    <script>
      if (!localStorage.getItem("accessToken")) {
        window.location.href = "/pages/login.html";
      }
    </script>
  </head>

  <body class="bg-gray-50 font-sans text-gray-800">
    <!-- Toasts -->
    <div
      id="toast-container"
      class="fixed top-4 right-4 z-[10000] space-y-2"
    ></div>

    <!-- Navbar -->
    <div id="header-placeholder"></div>

    <!-- Main -->
    <main class="max-w-6xl mx-auto mt-16 px-6">
      <div
        class="bg-white shadow-lg rounded-2xl p-8 flex flex-col lg:flex-row gap-8"
      >
        <!-- Sidebar -->
        <aside class="lg:w-1/4 w-full sm:border-b md:border-r border-gray-200">
          <div class="text-center">
            <div
              class="w-24 h-24 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center text-3xl text-gray-500"
            >
              <i class="fas fa-user"></i>
            </div>
            <h2 id="sidebarName" class="text-2xl font-semibold">User</h2>
            <p
              id="sidebarLocation"
              class="text-sm text-gray-500 mt-1 flex items-center justify-center"
            >
              <i class="fas fa-map-marker-alt mr-1"></i> Location
            </p>
          </div>

          <div class="mt-8 grid gap-3">
            <button
              id="navProfile"
              class="flex items-center justify-between w-full bg-yellow-400 hover:bg-yellow-500 transition text-black font-medium px-4 py-2 rounded-lg"
              type="button"
            >
              Profile Information
            </button>
            <button
              id="navBookings"
              class="flex items-center justify-between w-full border border-gray-300 hover:bg-gray-100 transition text-gray-700 font-medium px-4 py-2 rounded-lg"
              type="button"
            >
              Booking History
            </button>
          </div>
        </aside>

        <!-- Content -->
        <section class="lg:w-3/4 w-full">
          <!-- Profile Section -->
          <section id="profileSection">
            <h2 class="text-xl font-semibold mb-6 border-b pb-2">
              Personal Information
            </h2>

            <form
              id="profileForm"
              class="grid grid-cols-1 md:grid-cols-2 gap-6"
            >
              <div>
                <label class="block text-sm font-medium mb-1" for="profileName"
                  >Name</label
                >
                <input
                  disabled
                  id="profileName"
                  type="text"
                  autocomplete="name"
                  class="w-full border border-gray-300 px-4 py-2 rounded-lg bg-gray-100"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="profilePhone"
                  >Phone</label
                >
                <input
                  disabled
                  id="profilePhone"
                  type="tel"
                  inputmode="tel"
                  autocomplete="tel"
                  class="w-full border border-gray-300 px-4 py-2 rounded-lg bg-gray-100"
                />
              </div>
              <div>
                <label
                  class="block text-sm font-medium mb-1"
                  for="profileLocation"
                  >Country</label
                >
                <input
                  disabled
                  id="profileLocation"
                  type="text"
                  autocomplete="country-name"
                  class="w-full border border-gray-300 px-4 py-2 rounded-lg bg-gray-100"
                />
              </div>
            </form>

            <!-- Actions -->
            <div class="mt-6 flex items-center gap-3">
              <button
                id="editSaveBtn"
                class="bg-yellow-400 hover:bg-yellow-500 text-white font-medium px-5 py-2.5 rounded-lg transition"
              >
                <i class="fas fa-pen mr-2"></i><span>Edit</span>
              </button>
              <button
                id="cancelBtn"
                class="hidden border border-gray-300 hover:bg-gray-100 text-gray-700 font-medium px-4 py-2 rounded-lg transition"
                type="button"
              >
                Cancel
              </button>
              <span id="saveHint" class="hidden text-sm text-gray-500"
                >Edit your details, then click <b>Save changes</b>.</span
              >
            </div>

            <h2 class="text-xl font-semibold mt-10 mb-6 border-b pb-2">
              Security
            </h2>
            <form class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium mb-1" for="profileEmail"
                  >Email Address</label
                >
                <input
                  disabled
                  id="profileEmail"
                  type="email"
                  class="w-full border border-gray-300 px-4 py-2 rounded-lg bg-gray-100"
                />
              </div>
            </form>
          </section>

          <!-- Booking Section -->
          <section id="bookingSection" class="hidden">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-semibold border-b pb-2 w-full">
                Booking History
              </h2>
            </div>

            <!-- Error -->
            <div
              id="bookingsError"
              class="hidden mb-4 p-3 rounded-lg bg-red-50 text-red-700 text-sm"
            >
              Couldn’t load bookings. Please try again.
            </div>

            <!-- Empty -->
            <div
              id="bookingsEmpty"
              class="hidden text-center py-10 text-gray-500"
            >
              <i class="fas fa-calendar-times text-4xl mb-3"></i>
              <p>No bookings yet.</p>
            </div>

            <!-- Loading skeleton -->
            <div
              id="bookingsLoading"
              class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"
            >
              <div class="p-4 rounded-xl border bg-white animate-pulse">
                <div class="h-5 w-40 bg-gray-200 rounded mb-3"></div>
                <div class="h-4 w-56 bg-gray-200 rounded mb-2"></div>
                <div class="h-4 w-28 bg-gray-200 rounded mb-4"></div>
                <div class="flex justify-between items-center">
                  <div class="h-6 w-20 bg-gray-200 rounded"></div>
                  <div class="h-8 w-24 bg-gray-200 rounded"></div>
                </div>
              </div>
              <div class="p-4 rounded-xl border bg-white animate-pulse"></div>
              <div class="p-4 rounded-xl border bg-white animate-pulse"></div>
            </div>

            <!-- Cards -->
            <div
              id="bookingsGrid"
              class="hidden grid sm:grid-cols-2 lg:grid-cols-3 gap-4"
            ></div>
          </section>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <div id="footer-placeholder" class="mt-10"></div>

    <!-- Tiny toast -->
    <div
      id="toast"
      class="fixed top-4 right-4 z-50 hidden px-4 py-2 rounded-lg text-white shadow-lg"
    ></div>

    <!-- Shared scripts -->
    <script src="../JS/translation.js"></script>
    <script src="../JS/transition.js"></script>
    <script src="../JS/includes.js"></script>

    <!-- Profile page logic (existing) -->
    <script>
      // --- Helpers
      function showToast(msg, type = "success") {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.className =
          "fixed bottom-6 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-white shadow-lg " +
          (type === "success" ? "bg-green-600" : "bg-red-600");
        t.classList.remove("hidden");
        setTimeout(() => t.classList.add("hidden"), 2500);
      }

      function setInputsDisabled(disabled) {
        const ids = ["profileName", "profilePhone", "profileLocation"];
        ids.forEach((id) => {
          const el = document.getElementById(id);
          el.disabled = disabled;
          el.classList.toggle("bg-gray-100", disabled);
        });
      }

      // Populate from global currentUser if includes.js provides it
      function populateProfileWhenReady() {
        if (window.currentUser) {
          const user = window.currentUser;
          document.getElementById("profileName").value = user.fullName || "";
          document.getElementById("profilePhone").value =
            user.phoneNumber || "";
          document.getElementById("profileLocation").value = user.country || "";
          document.getElementById("profileEmail").value = user.email || "";

          document.getElementById("sidebarName").textContent =
            user.fullName || "User";
          document.getElementById("sidebarLocation").innerHTML =
            '<i class="fas fa-map-marker-alt mr-1"></i> ' +
            (user.country || "Location");
        } else {
          setTimeout(populateProfileWhenReady, 100);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        populateProfileWhenReady();

        const editSaveBtn = document.getElementById("editSaveBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const saveHint = document.getElementById("saveHint");

        // Keep a copy to restore on Cancel
        let original = { name: "", phone: "", country: "" };
        let editing = false;

        function snapshotValues() {
          original = {
            name: document.getElementById("profileName").value,
            phone: document.getElementById("profilePhone").value,
            country: document.getElementById("profileLocation").value,
          };
        }

        function restoreValues() {
          document.getElementById("profileName").value = original.name;
          document.getElementById("profilePhone").value = original.phone;
          document.getElementById("profileLocation").value = original.country;
        }

        function setEditingState(on) {
          editing = on;
          setInputsDisabled(!on);
          cancelBtn.classList.toggle("hidden", !on);
          saveHint.classList.toggle("hidden", !on);

          const icon = editSaveBtn.querySelector("i");
          const label = editSaveBtn.querySelector("span");
          if (on) {
            icon.className = "fas fa-save mr-2";
            label.textContent = "Save changes";
            editSaveBtn.classList.remove(
              "bg-yellow-400",
              "hover:bg-yellow-500"
            );
            editSaveBtn.classList.add("bg-green-600", "hover:bg-green-700");
          } else {
            icon.className = "fas fa-pen mr-2";
            label.textContent = "Edit";
            editSaveBtn.classList.add("bg-yellow-400", "hover:bg-yellow-500");
            editSaveBtn.classList.remove("bg-green-600", "hover:bg-green-700");
          }
        }

        async function callUpdateEndpoint(fullName, phoneNumber, country) {
          const token = localStorage.getItem("accessToken");
          const params = new URLSearchParams({
            FullName: fullName,
            PhoneNumber: phoneNumber,
            Country: country,
          });

          return fetch("/api/Auth/Update?" + params.toString(), {
            method: "POST",
            headers: token ? { Authorization: `Bearer ${token}` } : {},
            credentials: "include",
          });
        }

        function validateInputs({ name, phone, country }) {
          if (!name.trim() || !country.trim() || !phone.trim()) {
            return "Name, Phone, and Country are required.";
          }
          if (!/^[\\d+\\-\\s()]{6,}$/.test(phone.trim())) {
            return "Please enter a valid phone number.";
          }
          return null;
        }

        async function handleSave() {
          const name = document.getElementById("profileName").value.trim();
          const phone = document.getElementById("profilePhone").value.trim();
          const country = document
            .getElementById("profileLocation")
            .value.trim();

          const err = validateInputs({ name, phone, country });
          if (err) {
            showToast(err, "error");
            return;
          }

          editSaveBtn.disabled = true;
          const icon = editSaveBtn.querySelector("i");
          const label = editSaveBtn.querySelector("span");
          icon.className = "fas fa-circle-notch fa-spin mr-2";
          label.textContent = "Saving…";

          try {
            const res = await callUpdateEndpoint(name, phone, country);
            if (!res.ok) {
              let errorMsg = res.statusText;
              try {
                const payload = await res.json();
                if (payload?.errors) {
                  errorMsg = Array.isArray(payload.errors)
                    ? payload.errors.join(", ")
                    : String(payload.errors);
                } else if (payload?.message) {
                  errorMsg = payload.message;
                }
              } catch (_) {}
              throw new Error(errorMsg || "Update failed");
            }

            document.getElementById("sidebarName").textContent = name;
            document.getElementById("sidebarLocation").innerHTML =
              '<i class="fas fa-map-marker-alt mr-1"></i> ' + country;

            if (window.currentUser) {
              window.currentUser.fullName = name;
              window.currentUser.phoneNumber = phone;
              window.currentUser.country = country;
            }

            snapshotValues();
            setEditingState(false);
            showToast("Profile updated successfully.");
          } catch (ex) {
            console.error(ex);
            showToast(ex.message || "Could not update profile.", "error");
          } finally {
            editSaveBtn.disabled = false;
            if (editing) {
              icon.className = "fas fa-save mr-2";
              label.textContent = "Save changes";
            } else {
              icon.className = "fas fa-pen mr-2";
              label.textContent = "Edit";
            }
          }
        }

        // Button actions
        editSaveBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          if (!editing) {
            snapshotValues();
            setEditingState(true);
            document.getElementById("profileName").focus();
          } else {
            await handleSave();
          }
        });

        cancelBtn.addEventListener("click", (e) => {
          e.preventDefault();
          restoreValues();
          setEditingState(false);
        });
      });
    </script>

    <!-- Booking history logic -->
    <script>
      (function () {
        const grid = () => document.getElementById("bookingsGrid");
        const loading = () => document.getElementById("bookingsLoading");
        const empty = () => document.getElementById("bookingsEmpty");
        const errorBox = () => document.getElementById("bookingsError");

        let bookingsCache = null; // cache after first fetch
        let loadedOnce = false;

        const STATUS_STYLES = {
          Pending: { cls: "bg-yellow-100 text-yellow-800", icon: "fa-clock" },
          Confirmed: {
            cls: "bg-green-100 text-green-800",
            icon: "fa-circle-check",
          },
          Canceled: { cls: "bg-red-100 text-red-800", icon: "fa-circle-xmark" },
          Cancelled: {
            cls: "bg-red-100 text-red-800",
            icon: "fa-circle-xmark",
          }, // just in case
          Rejected: { cls: "bg-gray-100 text-gray-700", icon: "fa-ban" },
        };

        function statusBadge(status) {
          const s = STATUS_STYLES[status] || {
            cls: "bg-gray-100 text-gray-700",
            icon: "fa-info-circle",
          };
          return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${s.cls}">
              <i class="fa-solid ${s.icon}"></i> ${status}
            </span>`;
        }

        function formatMoney(v) {
          if (typeof v !== "number") return String(v ?? "");
          try {
            return v.toLocaleString();
          } catch (_) {
            return String(v);
          }
        }

        function bookingCard(b) {
          const isPending = String(b.status).toLowerCase() === "pending";
          return `
            <article class="booking-card p-4 rounded-xl border bg-white shadow-sm hover:shadow transition" data-id="${
              b.id
            }">
              <div class="flex items-start justify-between gap-3">
                <h3 class="font-semibold text-gray-900 leading-snug line-clamp-2 mr-2">${
                  b.tripName
                }</h3>
                ${statusBadge(b.status)}
              </div>

              <div class="mt-2 text-sm text-gray-600 space-y-1">
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-user text-gray-400"></i>
                  <span class="truncate">${b.userName}</span>
                </div>
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-phone text-gray-400"></i>
                  <span class="truncate">${b.phoneNumber}</span>
                </div>
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-tag text-gray-400"></i>
                  <span>Total: <b>${formatMoney(b.totalCost)}</b></span>
                </div>
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-fingerprint text-gray-400"></i>
                  <code class="text-xs bg-gray-50 px-1.5 py-0.5 rounded break-all">${
                    b.bookingPublicId
                  }</code>
                  <button class="copy-id ml-1 text-xs underline hover:no-underline" type="button" data-id="${
                    b.bookingPublicId
                  }">
                    Copy
                  </button>
                </div>
              </div>

              <div class="mt-4 flex items-center justify-between">
                <div class="text-xs text-gray-400">#${b.id}</div>
                ${
                  isPending
                    ? `<button class="delete-booking inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm"
                           type="button" data-bid="${b.id}">
                         <i class="fa-solid fa-trash"></i> Delete
                       </button>`
                    : `<button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border text-gray-500 text-sm cursor-not-allowed opacity-60" disabled>
                         <i class="fa-solid fa-ban"></i> Delete
                       </button>`
                }
              </div>
            </article>
          `;
        }

        function renderBookings(list) {
          loading().classList.add("hidden");
          errorBox().classList.add("hidden");

          if (!list || list.length === 0) {
            empty().classList.remove("hidden");
            grid().classList.add("hidden");
            return;
          }

          empty().classList.add("hidden");
          const html = list.map(bookingCard).join("");
          const g = grid();
          g.innerHTML = html;
          g.classList.remove("hidden");
        }

        async function fetchBookings() {
          const token = localStorage.getItem("accessToken");
          loading().classList.remove("hidden");
          empty().classList.add("hidden");
          grid().classList.add("hidden");
          errorBox().classList.add("hidden");

          try {
            const res = await fetch("/api/Booking/GetAllBookings", {
              method: "GET",
              headers: token ? { Authorization: `Bearer ${token}` } : {},
              credentials: "include",
            });

            if (!res.ok) {
              let msg = res.statusText;
              try {
                const payload = await res.json();
                msg = payload?.message || msg;
              } catch (_) {}
              throw new Error(msg || "Failed to fetch bookings.");
            }

            const payload = await res.json();
            const rows = payload?.data?.data || [];
            bookingsCache = rows;
            renderBookings(rows);
          } catch (err) {
            console.error(err);
            loading().classList.add("hidden");
            errorBox().textContent =
              "Couldn’t load bookings. " + (err?.message || "");
            errorBox().classList.remove("hidden");
          } finally {
            loadedOnce = true;
          }
        }

        async function deleteBooking(id, btn) {
          const token = localStorage.getItem("accessToken");
          if (!confirm("Delete this booking? This action cannot be undone.")) {
            return;
          }

          // lock UI
          btn.disabled = true;
          const prevHtml = btn.innerHTML;
          btn.innerHTML =
            '<i class="fa-solid fa-circle-notch fa-spin"></i> Deleting…';

          try {
            const res = await fetch(`/api/Booking/DeleteBooking/${id}`, {
              method: "DELETE",
              headers: token ? { Authorization: `Bearer ${token}` } : {},
              credentials: "include",
            });

            if (!res.ok) {
              let msg = res.statusText;
              try {
                const payload = await res.json();
                msg = payload?.message || msg;
              } catch (_) {}
              throw new Error(msg || "Delete failed");
            }

            // Remove from cache + UI
            if (Array.isArray(bookingsCache)) {
              bookingsCache = bookingsCache.filter(
                (b) => String(b.id) !== String(id)
              );
            }
            const card = btn.closest(".booking-card");
            card?.classList.add("opacity-50", "pointer-events-none");
            setTimeout(() => card?.remove(), 150);

            showToast("Booking deleted.");
            if (!grid().querySelector(".booking-card")) {
              renderBookings([]);
            }
          } catch (err) {
            console.error(err);
            showToast(err?.message || "Could not delete booking.", "error");
            btn.disabled = false;
            btn.innerHTML = prevHtml;
          }
        }

        // Copy public id
        function copyText(t) {
          try {
            navigator.clipboard.writeText(t);
            showToast("Copied!");
          } catch (_) {
            showToast("Copy failed", "error");
          }
        }

        // Sidebar nav
        function setActiveNav(which) {
          const btnProfile = document.getElementById("navProfile");
          const btnBookings = document.getElementById("navBookings");
          const profileSection = document.getElementById("profileSection");
          const bookingSection = document.getElementById("bookingSection");

          const onProfile = which === "profile";
          profileSection.classList.toggle("hidden", !onProfile);
          bookingSection.classList.toggle("hidden", onProfile);

          if (onProfile) {
            btnProfile.classList.add(
              "bg-yellow-400",
              "hover:bg-yellow-500",
              "text-black"
            );
            btnProfile.classList.remove(
              "border",
              "border-gray-300",
              "text-gray-700"
            );
            btnBookings.classList.remove(
              "bg-yellow-400",
              "hover:bg-yellow-500",
              "text-black"
            );
            btnBookings.classList.add(
              "border",
              "border-gray-300",
              "text-gray-700"
            );
          } else {
            btnBookings.classList.add(
              "bg-yellow-400",
              "hover:bg-yellow-500",
              "text-black"
            );
            btnBookings.classList.remove(
              "border",
              "border-gray-300",
              "text-gray-700"
            );
            btnProfile.classList.remove(
              "bg-yellow-400",
              "hover:bg-yellow-500",
              "text-black"
            );
            btnProfile.classList.add(
              "border",
              "border-gray-300",
              "text-gray-700"
            );
          }
        }

        document.addEventListener("DOMContentLoaded", () => {
          // Nav clicks
          document
            .getElementById("navProfile")
            .addEventListener("click", () => {
              setActiveNav("profile");
            });
          document
            .getElementById("navBookings")
            .addEventListener("click", async () => {
              setActiveNav("bookings");
              if (!loadedOnce) {
                await fetchBookings();
              }
            });

          // Default: show profile; you can auto-open bookings by calling setActiveNav("bookings")
          setActiveNav("profile");

          // Delegated actions for bookings grid
          grid().addEventListener("click", (e) => {
            const delBtn = e.target.closest(".delete-booking");
            if (delBtn) {
              const id = delBtn.getAttribute("data-bid");
              deleteBooking(id, delBtn);
              return;
            }
            const copyBtn = e.target.closest(".copy-id");
            if (copyBtn) {
              copyText(copyBtn.getAttribute("data-id"));
            }
          });
        });
      })();
    </script>

    <!-- BLOCKING MODAL: Complete profile after Google sign-in (unchanged) -->
    <script>
      (function () {
        if (localStorage.getItem("mustCompleteProfile") !== "1") return;

        function toast(message, ok = true) {
          const tc = document.getElementById("toast-container");
          const el = document.createElement("div");
          el.className =
            "max-w-sm w-full px-4 py-3 rounded-lg shadow-lg text-white animate-fade-in-up transition " +
            (ok ? "bg-green-600" : "bg-red-600");
          el.textContent = message;
          tc.appendChild(el);
          setTimeout(() => {
            el.style.opacity = "0";
            el.addEventListener("transitionend", () => el.remove());
          }, 3500);
        }

        function lockScroll(lock) {
          document.documentElement.style.overflow = lock ? "hidden" : "";
        }

        const countries = [
          "Egypt",
          "Saudi Arabia",
          "UAE",
          "Qatar",
          "Kuwait",
          "Jordan",
          "Bahrain",
          "Oman",
          "Morocco",
          "Algeria",
          "Tunisia",
          "Libya",
          "Lebanon",
          "Iraq",
          "Syria",
          "Yemen",
          "Turkey",
          "USA",
          "UK",
          "France",
          "Germany",
          "Italy",
          "Spain",
          "Netherlands",
          "Switzerland",
          "Sweden",
          "Norway",
          "Denmark",
          "Finland",
          "Canada",
          "Brazil",
          "Argentina",
          "Mexico",
          "South Africa",
          "Kenya",
          "Nigeria",
          "India",
          "Pakistan",
          "Bangladesh",
          "China",
          "Japan",
          "South Korea",
          "Indonesia",
          "Malaysia",
          "Philippines",
          "Australia",
          "New Zealand",
          "Russia",
          "Ukraine",
          "Romania",
          "Poland",
          "Portugal",
          "Greece",
          "Ireland",
          "Austria",
          "Belgium",
          "Singapore",
          "Vietnam",
          "Thailand",
          "Sri Lanka",
        ];

        const overlay = document.createElement("div");
        overlay.id = "completeProfileModal";
        overlay.className =
          "fixed inset-0 z-[9999] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4";

        const u = window.currentUser || {};
        const safeName = (u.fullName || "").replace(/\"/g, "&quot;");

        overlay.innerHTML = `
          <div class="bg-white w-full max-w-md rounded-2xl shadow-xl p-6 relative">
            <h2 class="text-xl font-semibold mb-1">Complete your profile</h2>
            <p class="text-sm text-gray-600 mb-4">Please add your phone number and country to continue.</p>

            <form id="cpForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input required id="cpName" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2" value="${safeName}">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number <span class="text-red-500">*</span></label>
                <input id="cpPhone" type="tel" inputmode="tel" placeholder="+201234567890"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2" required />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Country <span class="text-red-500">*</span></label>
                <select id="cpCountry" class="w-full border border-gray-300 rounded-lg px-3 py-2" required></select>
              </div>

              <button id="cpSave" type="submit"
                      class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-2 rounded-lg">
                Save & Continue
              </button>
              <p class="text-[11px] text-gray-500 text-center">You can’t navigate away until this is saved.</p>
            </form>
          </div>
        `;

        document.body.appendChild(overlay);
        lockScroll(true);

        const sel = overlay.querySelector("#cpCountry");
        countries.forEach((c) => {
          const o = document.createElement("option");
          o.value = c;
          o.textContent = c;
          sel.appendChild(o);
        });
        sel.value = u.country || "Egypt";

        overlay.addEventListener(
          "click",
          (e) => {
            const card = overlay.firstElementChild;
            if (!card.contains(e.target)) {
              e.stopPropagation();
              e.preventDefault();
            }
          },
          true
        );
        document.addEventListener(
          "keydown",
          (e) => {
            if (e.key === "Escape") e.preventDefault();
          },
          true
        );

        overlay
          .querySelector("#cpForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = overlay.querySelector("#cpName").value.trim();
            const phone = overlay.querySelector("#cpPhone").value.trim();
            const country = overlay.querySelector("#cpCountry").value.trim();

            if (!/^[\\d+\\-\\s()]{6,}$/.test(phone)) {
              toast("Please enter a valid phone number.", false);
              return;
            }
            if (!country) {
              toast("Please choose your country.", false);
              return;
            }

            const btn = overlay.querySelector("#cpSave");
            const prev = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Saving…";

            const token = localStorage.getItem("accessToken");
            const params = new URLSearchParams({
              FullName: name || u.fullName || "",
              PhoneNumber: phone,
              Country: country,
            });

            try {
              const res = await fetch(`/api/Auth/Update?${params.toString()}`, {
                method: "POST",
                headers: token ? { Authorization: `Bearer ${token}` } : {},
                credentials: "include",
              });

              if (!res.ok) {
                let msg = res.statusText;
                try {
                  const payload = await res.json();
                  msg =
                    payload?.message ||
                    (Array.isArray(payload?.errors)
                      ? payload.errors.join(", ")
                      : msg);
                } catch (_) {}
                throw new Error(msg || "Update failed");
              }

              localStorage.setItem("mustCompleteProfile", "0");
              toast("Profile updated. You're good to go!");

              try {
                document.getElementById("profilePhone").value = phone;
                document.getElementById("profileLocation").value = country;
                if (name) document.getElementById("profileName").value = name;
                document.getElementById("sidebarName").textContent =
                  name || u.fullName || "User";
                document.getElementById("sidebarLocation").innerHTML =
                  '<i class="fas fa-map-marker-alt mr-1"></i> ' + country;
                if (window.currentUser) {
                  window.currentUser.fullName =
                    name || window.currentUser.fullName;
                  window.currentUser.phoneNumber = phone;
                  window.currentUser.country = country;
                }
              } catch (_) {}

              overlay.remove();
              lockScroll(false);

              const back = sessionStorage.getItem("afterProfile");
              if (back && back !== location.href) {
                sessionStorage.removeItem("afterProfile");
                location.href = back;
              }
            } catch (ex) {
              console.error(ex);
              toast(ex.message || "Could not update profile.", false);
            } finally {
              btn.disabled = false;
              btn.textContent = prev;
            }
          });
      })();
    </script>
  </body>
</html>
