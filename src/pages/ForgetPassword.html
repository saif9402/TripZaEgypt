<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex,nofollow" />
    <title data-i18n="forgot.pageTitle">Forgot Password | Tour Guide</title>

    <link href="../output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body class="relative min-h-screen overflow-x-hidden">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Background -->
    <div class="absolute inset-0">
      <img
        src="../img/sign in background.png"
        class="w-full h-full object-cover blur-xl"
        data-i18n-alt="img.bgBlurAlt"
        alt="blurred background"
      />
    </div>
    <img
      src="../img/sign in background.png"
      class="absolute inset-0 w-full h-full bg-img transition-opacity duration-700 opacity-0"
      loading="lazy"
      onload="this.style.opacity=1"
      data-i18n-alt="img.bgAlt"
      alt="background image"
    />

    <!-- Page content -->
    <div
      class="relative z-10 flex items-center justify-center min-h-screen px-4 bg-black/40"
    >
      <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
        <div class="p-4 flex items-center justify-center">
          <img
            src="../img/Vector.png"
            data-i18n-alt="img.logoAlt"
            alt="main logo"
            class="h-10"
          />
        </div>

        <h1
          class="text-2xl font-bold text-center text-gray-800"
          data-i18n="forgot.title"
        >
          Forgot your password?
        </h1>
        <p
          class="mt-2 text-center text-gray-500 text-sm"
          data-i18n="forgot.subtitle"
        >
          Enter your email and we’ll send you a reset link.
        </p>

        <!-- Form -->
        <form id="resetForm" class="mt-6 space-y-4" novalidate>
          <div>
            <label
              class="block text-sm text-gray-600 mb-1"
              for="email"
              data-i18n="signin.email"
              >Email</label
            >
            <input
              id="email"
              type="email"
              data-i18n-placeholder="forgot.email.placeholder"
              placeholder="you@example.com"
              autocomplete="email"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"
              required
            />
          </div>

          <button
            type="submit"
            id="submitBtn"
            class="w-full bg-yellow-400 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-yellow-500 transition disabled:opacity-60 disabled:cursor-not-allowed"
            data-i18n="forgot.submit"
          >
            Send Reset Link
          </button>

          <p class="text-center text-sm text-gray-500">
            <span data-i18n="forgot.remembered">Remembered it?</span>
            <a
              href="sign-in.html"
              class="text-yellow-600 hover:underline"
              data-i18n="forgot.backToSignIn"
            >
              Back to sign in
            </a>
          </p>

          <p
            class="text-xs text-gray-400 text-center mt-2"
            data-i18n="forgot.tip"
          >
            Tip: Check your spam/junk folder if you don’t see the email.
          </p>
        </form>

        <p class="text-center text-xs text-gray-400 mt-6">
          <span id="copyYear"></span>
          <span data-i18n="footer.copy.tail"
            >Tour Guide. All rights reserved.</span
          >
        </p>
      </div>
    </div>

    <!-- i18n core -->
    <script src="../JS/translation.js"></script>

    <!-- Page behavior -->
    <script>
      // Lightweight toast (uses your global showToast if present)
      function toast(message, type = "success") {
        if (window.showToast) return showToast(message, type);
        const wrap = document.getElementById("toast-container");
        const el = document.createElement("div");
        el.className = `
          max-w-sm w-full px-4 py-3 rounded-lg shadow-lg text-white transition
          ${type === "success" ? "bg-green-600" : "bg-red-600"}
        `;
        el.textContent = message;
        wrap.appendChild(el);
        setTimeout(() => {
          el.style.opacity = "0";
          el.style.transform = "translateY(-4px)";
          el.addEventListener("transitionend", () => el.remove());
        }, 3500);
      }

      (function () {
        const t = (k, p) =>
          typeof window.t === "function"
            ? window.t(k, p)
            : k.replace(/\{(\w+)\}/g, (_, m) =>
                p && p[m] != null ? p[m] : `{${m}}`
              );

        // Footer year
        const y = new Date().getFullYear();
        const copyYear = document.getElementById("copyYear");
        if (copyYear) copyYear.textContent = `© ${y} `;

        const form = document.getElementById("resetForm");
        const emailInput = document.getElementById("email");
        const submitBtn = document.getElementById("submitBtn");

        // Cooldown to avoid spam
        let cooldownTimer = null;
        function startCooldown(seconds = 30) {
          let remain = seconds;
          submitBtn.disabled = true;
          const base = t("forgot.cooldown", { s: remain }); // "Resend in {s}s"
          submitBtn.textContent = base;
          cooldownTimer = setInterval(() => {
            remain -= 1;
            if (remain <= 0) {
              clearInterval(cooldownTimer);
              submitBtn.disabled = false;
              submitBtn.textContent = t("forgot.submit");
            } else {
              submitBtn.textContent = t("forgot.cooldown", { s: remain });
            }
          }, 1000);
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = (emailInput.value || "").trim();
          if (!email) {
            emailInput.focus();
            return toast(t("forgot.error.noEmail"), "error");
          }

          // Basic client-side email check
          const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
          if (!emailOk) {
            emailInput.focus();
            return toast(t("forgot.error.invalidEmail"), "error");
          }

          const original = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = t("forgot.sending"); // "Sending…"

          try {
            const res = await fetch("/api/Auth/ForgetPassword", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            });

            let data = {};
            try {
              data = await res.json();
            } catch {}

            if (res.ok) {
              // Security-friendly: never reveal whether an email exists
              toast(t("forgot.successGeneric"), "success");
              form.reset();
              startCooldown(30);
            } else {
              toast(
                data?.errors?.join(", ") || t("forgot.error.generic"),
                "error"
              );
              submitBtn.disabled = false;
              submitBtn.textContent = original;
            }
          } catch (err) {
            console.error(err);
            toast(t("forgot.error.network"), "error");
            submitBtn.disabled = false;
            submitBtn.textContent = original;
          }
        });

        // Keep <title> updated after language switch
        function setPageTitle() {
          if (typeof window.t === "function") {
            document.title = window.t("forgot.pageTitle") || document.title;
          }
        }
        document.addEventListener("DOMContentLoaded", setPageTitle);
        const prev = window.refreshLangData;
        window.refreshLangData = async function (...args) {
          const out = await prev?.apply(this, args);
          setPageTitle();
          return out;
        };
      })();
    </script>
  </body>
</html>
