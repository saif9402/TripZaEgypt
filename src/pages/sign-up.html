<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Account | Tour Guide</title>
    <link href="../output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/styles.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="relative h-screen overflow-x-hidden overflow-y-auto">
    <!-- ‚úÖ Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- üî∏ Blurred Placeholder -->
    <div class="absolute inset-0">
      <img
        src="../img/sign in background.png"
        class="w-full h-full object-cover blur-xl"
        alt="blurred beach placeholder"
      />
    </div>

    <!-- üî∏ Full Image -->
    <img
      src="../img/sign in background.png"
      class="absolute inset-0 w-full h-full bg-img transition-opacity duration-700 opacity-0"
      loading="lazy"
      onload="this.style.opacity=1"
      alt="background beach"
    />

    <!-- üî∏ Content Container -->
    <div
      class="relative z-10 flex items-center justify-center h-screen px-4 bg-black/40"
    >
      <div
        class="bg-white rounded-2xl shadow-xl p-7 sm:p-7 md:p-7 max-w-md w-full max-h-[90vh] overflow-y-auto overflow-hidden justify-center items-center"
      >
        <div class="p-6 flex items-center justify-center">
          <img src="../img/Vector.png" alt="main logo" />
        </div>

        <!-- ‚úÖ Registration Form -->
        <form id="registerForm">
          <div class="relative min-h-[290px] sm:min-h-[290px] md:min-h-[290px]">
            <!-- Step 1 -->
            <div class="step step-active" data-step="1">
              <div class="space-y-4">
                <div>
                  <label
                    for="name"
                    class="block text-sm font-medium text-gray-600"
                    >Full Name</label
                  >
                  <input
                    id="name"
                    name="FullName"
                    type="text"
                    placeholder="Jane Doe"
                    class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 placeholder:italic placeholder-black/50"
                    required
                  />
                </div>

                <div>
                  <label
                    for="country"
                    class="block text-sm font-medium text-gray-600"
                    >Country</label
                  >
                  <select
                    id="country"
                    name="Country"
                    required
                    class="w-full mt-1 px-2 py-1 bg-white text-sm focus:outline-none"
                  >
                    <option value="">Select Country</option>
                  </select>
                </div>

                <div>
                  <label
                    for="phone"
                    class="block text-sm font-medium text-gray-600"
                    >Phone Number</label
                  >
                  <input
                    id="phone"
                    name="PhoneNumber"
                    type="text"
                    placeholder="+1234567890"
                    class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 placeholder:italic placeholder-black/50"
                    required
                  />
                </div>
              </div>

              <div class="flex justify-end pt-4">
                <button
                  type="button"
                  class="next-step bg-yellow-400 text-white font-semibold py-2 px-6 rounded-lg hover:bg-yellow-500"
                >
                  Next
                </button>
              </div>
            </div>

            <!-- Step 2 -->
            <div class="step step-hidden" data-step="2">
              <div class="space-y-4">
                <div>
                  <label
                    for="email"
                    class="block text-sm font-medium text-gray-600"
                    >Email</label
                  >
                  <input
                    id="email"
                    name="Email"
                    type="email"
                    placeholder="you@example.com"
                    class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 placeholder:italic placeholder-black/50"
                    required
                  />
                </div>

                <div class="relative">
                  <label
                    for="password"
                    class="block text-sm font-medium text-gray-600"
                    >Password</label
                  >
                  <input
                    id="password"
                    name="Password"
                    type="password"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full mt-1 px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 placeholder:italic placeholder-black/50"
                    required
                  />
                  <button
                    title="Password"
                    type="button"
                    onclick="togglePassword('password', this)"
                    class="absolute right-3 top-9 text-gray-500 hover:text-gray-700"
                    tabindex="-1"
                  >
                    <i class="fa-solid fa-eye"></i>
                  </button>
                </div>

                <div class="relative">
                  <label
                    for="confirm-password"
                    class="block text-sm font-medium text-gray-600"
                    >Confirm Password</label
                  >
                  <input
                    id="confirm-password"
                    type="password"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full mt-1 px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 placeholder:italic placeholder-black/50"
                    required
                  />
                  <button
                    title="Confirm password"
                    type="button"
                    onclick="togglePassword('confirm-password', this)"
                    class="absolute right-3 top-9 text-gray-500 hover:text-gray-700"
                    tabindex="-1"
                  >
                    <i class="fa-solid fa-eye"></i>
                  </button>
                </div>
              </div>

              <div class="flex justify-between pt-4">
                <button
                  type="button"
                  class="prev-step text-gray-600 hover:underline"
                >
                  ‚Üê Back
                </button>
                <button
                  type="submit"
                  class="bg-yellow-400 text-white font-semibold py-2 px-6 rounded-lg hover:bg-yellow-500"
                >
                  Create Account
                </button>
              </div>
            </div>
          </div>
        </form>

        <!-- Divider -->
        <div class="relative my-1">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-300"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-2 bg-white text-gray-500">Or continue with</span>
          </div>
        </div>

        <!-- Google Sign-In -->
        <a
          id="googleBtn"
          href="#"
          class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 rounded-lg py-2 px-4 shadow-sm hover:bg-gray-50 transition no-underline mb-2"
        >
          <img
            src="https://www.google.com/favicon.ico"
            alt="Google logo"
            class="w-5 h-5"
          />
          <span class="text-black font-medium">Sign Up with Google</span>
        </a>

        <p class="text-center text-xs text-gray-400 mt-4">
          Already have an account?
          <a href="sign-in.html" class="text-yellow-500 hover:underline"
            >Sign in</a
          >
        </p>
      </div>
    </div>

    <!-- Complete Profile Modal (shown after Google login) -->
    <div
      id="completeProfileModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
        <h3 class="text-lg font-semibold">Complete your profile</h3>
        <p class="text-sm text-gray-600 mb-4">
          We need your phone number and country to finish setting up your
          account.
        </p>

        <form id="completeProfileForm" class="space-y-4">
          <div>
            <label class="block text-sm text-gray-600">Full name</label>
            <input
              id="cp_name"
              type="text"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400"
            />
          </div>

          <div>
            <label class="block text-sm text-gray-600">Email</label>
            <input
              id="cp_email"
              type="email"
              disabled
              class="w-full px-3 py-2 border rounded-lg bg-gray-100"
            />
          </div>

          <div>
            <label class="block text-sm text-gray-600">Country</label>
            <select
              id="cp_country"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400"
            >
              <option value="">Select Country</option>
            </select>
          </div>

          <div>
            <label class="block text-sm text-gray-600">Phone number</label>
            <input
              id="cp_phone"
              type="tel"
              placeholder="+201234567890"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400"
            />
          </div>

          <div class="flex justify-end gap-3 pt-2">
            <button
              type="button"
              id="cp_logout"
              class="px-4 py-2 rounded-lg border hover:bg-gray-100"
            >
              Use another account
            </button>
            <button
              type="submit"
              id="cp_save"
              class="px-5 py-2 rounded-lg bg-yellow-400 text-black font-semibold hover:bg-yellow-500"
            >
              Save & Continue
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // --- Build Google link with a return URL back to THIS page
      (function wireGoogleBtn() {
        const btn = document.getElementById("googleBtn");
        if (!btn) return;
        const base =
          "https://tourguidehurghda.runasp.net/api/ExternalAuth/google-redirect-login";
        // If your backend uses a different query key than returnUrl, change it here.
        const returnUrl = `${location.origin}${location.pathname}`;
        const sep = base.includes("?") ? "&" : "?";
        btn.href = `${base}${sep}returnUrl=${encodeURIComponent(returnUrl)}`;
      })();

      // --- Small helper to show toasts (uses your existing showToast if present)
      function toast(msg, type = "success") {
        if (typeof showToast === "function") return showToast(msg, type);
        alert(msg);
      }

      // --- Decode JWT to pull name/email if backend doesn't send them as query params
      function decodeJwt(token) {
        try {
          const [, payload] = token.split(".");
          const json = atob(payload.replace(/-/g, "+").replace(/_/g, "/"));
          try {
            return JSON.parse(decodeURIComponent(escape(json)));
          } catch {
            return JSON.parse(json);
          }
        } catch {
          return {};
        }
      }

      // --- Countries (reuse the same list you used on sign-up)
      const COUNTRIES = [
        "Afghanistan",
        "Albania",
        "Algeria",
        "Argentina",
        "Australia",
        "Austria",
        "Bahrain",
        "Bangladesh",
        "Belgium",
        "Brazil",
        "Canada",
        "Chile",
        "China",
        "Colombia",
        "Denmark",
        "Egypt",
        "Finland",
        "France",
        "Germany",
        "Greece",
        "India",
        "Indonesia",
        "Iran",
        "Iraq",
        "Ireland",
        "Israel",
        "Italy",
        "Japan",
        "Jordan",
        "Kenya",
        "Kuwait",
        "Lebanon",
        "Libya",
        "Malaysia",
        "Mexico",
        "Morocco",
        "Netherlands",
        "New Zealand",
        "Nigeria",
        "Norway",
        "Oman",
        "Pakistan",
        "Peru",
        "Philippines",
        "Poland",
        "Portugal",
        "Qatar",
        "Romania",
        "Russia",
        "Saudi Arabia",
        "Singapore",
        "South Africa",
        "South Korea",
        "Spain",
        "Sri Lanka",
        "Sudan",
        "Sweden",
        "Switzerland",
        "Syria",
        "Thailand",
        "Tunisia",
        "Turkey",
        "UAE",
        "UK",
        "USA",
        "Ukraine",
        "Uzbekistan",
        "Venezuela",
        "Vietnam",
        "Yemen",
        "Zimbabwe",
      ];
      (function fillCountries() {
        const sel = document.getElementById("cp_country");
        if (!sel) return;
        COUNTRIES.forEach((c) => {
          const o = document.createElement("option");
          o.value = c;
          o.textContent = c;
          sel.appendChild(o);
        });
      })();

      // --- Modal helpers
      const modal = document.getElementById("completeProfileModal");
      function openModal() {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      function closeModal() {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      // --- Update endpoint (query params + Bearer)
      async function updateProfile(fullName, phone, country) {
        const token = localStorage.getItem("accessToken");
        const qs = new URLSearchParams({
          FullName: fullName,
          PhoneNumber: phone,
          Country: country,
        }).toString();
        const url = `/api/Auth/Update?${qs}`;
        const common = { headers: { Authorization: `Bearer ${token}` } };
        let res = await fetch(url, { method: "POST", ...common });

        return res;
      }

      // --- After Google redirects back here, capture token + force profile completion
      function handleGoogleCallback() {
        const sp = new URLSearchParams(location.search);
        const token = sp.get("accessToken") || sp.get("token") || sp.get("jwt");
        const qName = sp.get("fullName") || sp.get("name");
        const qEmail = sp.get("email") || sp.get("mail");

        if (!token) return; // Normal (non-Google) visit

        // Store token and clean URL
        localStorage.setItem("accessToken", token);
        history.replaceState({}, document.title, location.pathname);

        // Prefill name/email
        const claims = decodeJwt(token);
        document.getElementById("cp_name").value =
          qName || claims.fullName || claims.name || "";
        document.getElementById("cp_email").value =
          qEmail || claims.email || claims.unique_name || "";

        // Block the flow until user completes
        openModal();
      }

      // --- Modal actions
      document.getElementById("cp_logout")?.addEventListener("click", () => {
        localStorage.removeItem("accessToken");
        // Back to sign-in cleanly
        window.location.href = "sign-in.html";
      });

      document
        .getElementById("completeProfileForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const fullName = document.getElementById("cp_name").value.trim();
          const phone = document.getElementById("cp_phone").value.trim();
          const country = document.getElementById("cp_country").value.trim();

          if (!fullName || !phone || !country) {
            toast("Please fill in all fields.", "error");
            return;
          }
          if (!/^[\d+\-\s()]{6,}$/.test(phone)) {
            toast("Please enter a valid phone number.", "error");
            return;
          }

          const btn = document.getElementById("cp_save");
          const old = btn.textContent;
          btn.disabled = true;
          btn.textContent = "Saving‚Ä¶";

          try {
            const res = await updateProfile(fullName, phone, country);
            if (!res.ok) {
              let msg = res.statusText;
              try {
                const j = await res.json();
                msg =
                  j.message ||
                  (Array.isArray(j.errors) ? j.errors.join(", ") : j.errors) ||
                  msg;
              } catch {}
              throw new Error(msg || "Update failed");
            }

            // Done ‚Äî continue to profile (or wherever you want)
            toast("Profile completed!", "success");
            window.location.href = "profile.html";
          } catch (err) {
            console.error(err);
            toast(err.message || "Could not save profile.", "error");
          } finally {
            btn.disabled = false;
            btn.textContent = old;
          }
        });

      // Kick off handler on page load
      document.addEventListener("DOMContentLoaded", handleGoogleCallback);
    </script>

    <!-- Optional Scripts -->
    <script src="../JS/translation.js"></script>
    <script src="../JS/transition.js"></script>
  </body>
</html>
